<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>WolfPack Volleyball — Team Logger, Rotation, Events & Dashboards</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#f9f9f9;
    --text:#000000;
    --muted:#6b7280;
    --line:#e5e7eb;
    --accent:#ff7f11;
    --accent2:#ff9933;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,var(--accent),#f36f00);color:#fff;padding:14px 16px;font-weight:900;font-size:18px}
  .container{max-width:1320px;margin:20px auto;padding:0 16px;display:grid;gap:16px;grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  h1{margin:0 0 8px;font-size:18px;color:#000}
  .sub{color:var(--muted);font-size:13px;margin:6px 0 10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{user-select:none;border:1px solid var(--line);border-radius:10px;padding:8px 12px;font-weight:700;font-size:14px;cursor:pointer;background:#fff;color:#000}
  .btn.accent{border-color:transparent;background:linear-gradient(180deg,var(--accent),#f36f00);color:#fff}
  .btn.ghost{background:#fff}
  .btn.small{padding:6px 10px;font-size:12px}
  .input{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;color:#000}
  .input.num{width:90px}
  select.input{padding-right:28px}
  .roster{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
  .person{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .tag{background:#fff;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;color:#000;margin-right:8px}
  .name{flex:1 1 auto;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* Court maps */
  .court{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .slot{border:2px solid var(--line);border-radius:12px;min-height:72px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff;text-align:center;padding:8px;position:relative}
  .slot .zone{position:absolute;top:6px;left:8px;font-size:11px;color:var(--accent)}
  .slot .num{font-weight:900;color:#000}
  .slot .pname{font-size:12px;color:#444}
  .slot.active{outline:3px solid var(--accent)}
  .net{grid-column:1/-1;text-align:center;color:#000;font-weight:900;letter-spacing:.1em;border:2px dashed var(--accent);border-radius:10px;padding:4px 0;background:linear-gradient(180deg,#fff,var(--card))}
  /* Display, tables */
  .display{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;margin:8px 0}
  .code{font-size:22px;font-weight:900;color:var(--accent)}
  .pill{background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:#000}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
  thead tr{background:#ffe8d1}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:13px}
  th{font-weight:800;color:#000}
  .table-actions button{margin-right:6px}
</style>
</head>
<body>
<header>WolfPack Volleyball — Team Logger, Rotation, Events & Dashboards</header>

<div class="container">
  <!-- LEFT: TEAM SIDE -->
  <section class="grid" style="align-content:start;gap:16px">
    <div class="card">
      <h1>Event / Session</h1>
      <div class="row" style="margin-bottom:8px">
        <select id="eventSelect" class="input" style="min-width:220px"></select>
        <input id="eventName" class="input" placeholder="New event name (e.g., Practice 09/18)">
        <button class="btn accent" id="eventAdd">Add Event</button>
        <button class="btn ghost" id="eventDelete">Delete Event</button>
      </div>
      <div class="sub">Each event keeps its own log and dashboards.</div>
    </div>

    <div class="card">
      <h1>Team Roster</h1>
      <div class="row" style="margin-bottom:8px">
        <input id="teamNum" class="input num" placeholder="Player #" inputmode="numeric">
        <input id="teamName" class="input" style="min-width:220px" placeholder="Player Name">
        <button class="btn accent" id="teamAdd">Add</button>
        <button class="btn ghost" id="teamClear">Clear Active/Bench</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="teamRosterName" class="input" placeholder="Save roster as (e.g., WolfPack A)">
        <button class="btn" id="teamRosterSave">Save Roster</button>
        <select id="teamRosterLoad" class="input" style="min-width:200px"></select>
        <button class="btn" id="teamRosterApply">Load to Roster</button>
      </div>
      <div id="teamRoster" class="roster"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h1>Team Court</h1>
          <div class="sub">Tap a slot to select (highlight). Then tap a roster player to assign. Long‑press a slot to clear. Duplicate prevention is enforced.</div>
        </div>
        <div class="row">
          <button id="teamRotateCW" class="btn small">Rotate ⟳</button>
          <button id="teamRotateCCW" class="btn small">Rotate ⟲</button>
        </div>
      </div>
      <div id="teamCourt" class="court">
        <div class="slot" id="team1"><span class="zone">Z1</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="team6"><span class="zone">Z6</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="team5"><span class="zone">Z5</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="team2"><span class="zone">Z2</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="team3"><span class="zone">Z3</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="team4"><span class="zone">Z4</span><div class="num"></div><div class="pname"></div></div>
        <div class="net">NET</div>
      </div>
      <div class="sub" id="teamHint">Selected: none</div>
    </div>

    <div class="card">
      <h1>Touch Logger</h1>
      <div class="display">
        <div>
          <div style="font-size:12px;color:var(--muted)">Current Entry</div>
          <div class="code" id="code">--</div>
        </div>
        <div class="row">
          <span class="pill" id="pillSide">Side: --</span>
          <span class="pill" id="pillPlayer">Player: --</span>
          <span class="pill" id="pillAction">Action: --</span>
          <span class="pill" id="pillQual">Qualifier: --</span>
        </div>
      </div>
      <div class="sub">Actions</div>
      <div class="row" id="actions">
        <button class="btn" data-action="R">R (Receive)</button>
        <button class="btn" data-action="S">S (Serve)</button>
        <button class="btn" data-action="T">T (Set)</button>
        <button class="btn" data-action="D">D (Dig)</button>
        <button class="btn" data-action="F">F (Free)</button>
        <button class="btn" data-action="B">B (Block)</button>
        <button class="btn" data-action="A">A (Attack)</button>
      </div>
      <div class="sub">Qualifiers</div>
      <div class="row" id="quals"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="reset">Reset</button>
        <button class="btn accent" id="enter">Enter</button>
      </div>
    </div>

    <div class="card">
      <h1>Event Log</h1>
      <table id="log"><thead><tr><th>#</th><th>Time</th><th>Side</th><th>Code</th><th>P#</th><th>Name</th><th>Action</th><th>Qualifier</th><th>Meaning</th><th>Tools</th></tr></thead><tbody></tbody></table>
      <div class="row" style="margin-top:10px">
        <button id="exportCSV" class="btn">Export CSV</button>
        <button id="clearLog" class="btn ghost">Clear All Logs</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: OPP SIDE + DASHBOARDS -->
  <section class="grid" style="align-content:start;gap:16px">
    <div class="card">
      <h1>Opponent Roster</h1>
      <div class="row" style="margin-bottom:8px">
        <input id="oppNum" class="input num" placeholder="Player #" inputmode="numeric">
        <input id="oppName" class="input" style="min-width:220px" placeholder="Player Name">
        <button class="btn accent" id="oppAdd">Add</button>
        <button class="btn ghost" id="oppClear">Clear Active/Bench</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="oppRosterName" class="input" placeholder="Save roster as (e.g., Opp A)">
        <button class="btn" id="oppRosterSave">Save Roster</button>
        <select id="oppRosterLoad" class="input" style="min-width:200px"></select>
        <button class="btn" id="oppRosterApply">Load to Roster</button>
      </div>
      <div id="oppRoster" class="roster"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h1>Opponent Court</h1>
          <div class="sub">Tap a slot to select (highlight). Then tap a roster player to assign. Long‑press a slot to clear. Duplicate prevention is enforced.</div>
        </div>
        <div class="row">
          <button id="oppRotateCW" class="btn small">Rotate ⟳</button>
          <button id="oppRotateCCW" class="btn small">Rotate ⟲</button>
        </div>
      </div>
      <div id="oppCourt" class="court">
        <div class="slot" id="opp1"><span class="zone">Z1</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="opp6"><span class="zone">Z6</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="opp5"><span class="zone">Z5</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="opp2"><span class="zone">Z2</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="opp3"><span class="zone">Z3</span><div class="num"></div><div class="pname"></div></div>
        <div class="slot" id="opp4"><span class="zone">Z4</span><div class="num"></div><div class="pname"></div></div>
        <div class="net">NET</div>
      </div>
      <div class="sub" id="oppHint">Selected: none</div>
    </div>

    <div class="card">
      <h1>Player Dashboard</h1>
      <div class="sub">Aggregated per‑player stats for the selected event.</div>
      <table id="dash"><thead><tr><th>Side</th><th>#</th><th>Name</th><th>R3</th><th>R2</th><th>R1</th><th>R0</th><th>SA</th><th>S+</th><th>S-</th><th>SE</th><th>AK</th><th>AE</th><th>BK</th><th>BE</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card">
      <h1>Rotation Dashboards</h1>
      <div class="sub">Serve‑rotation and receive side‑out metrics (Team side).
        Rotation counter follows the Team rotation buttons. "SR#" = serve while in rotation #; "SO#" = side‑out while receiving in rotation #.</div>
      <table id="rotServe"><thead><tr><th>Serve Rotation</th><th>Serves</th><th>Aces</th><th>Errors</th><th>Ace%</th><th>Error%</th></tr></thead><tbody></tbody></table>
      <div style="height:8px"></div>
      <table id="rotSO"><thead><tr><th>Receive Rotation</th><th>Attempts</th><th>Success</th><th>SO%</th></tr></thead><tbody></tbody></table>
    </div>
  </section>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const el=(t,cls,txt)=>{const e=document.createElement(t); if(cls) e.className=cls; if(txt!==undefined) e.textContent=txt; return e;};
  const num2=v=>String(v||'').replace(/\D/g,'').slice(-2).padStart(2,'0');
  const now=()=>new Date().toLocaleTimeString();
  const trunc=(s,n=18)=> (s||'').length>n ? s.slice(0,n-1)+'…' : (s||'');

  // Qualifiers & meanings
  const QUALS={ R:["3","2","1","0"], S:["A","+","-","E"], A:["K","B","-","E"], B:["K","T","M","E"], D:["3","2","1","0"], T:["3","2","1","0"], F:["Y","E"] };
  const MEAN={ R3:"Receive: excellent", R2:"Receive: good", R1:"Receive: poor", R0:"Receive: loss",
               SA:"Serve: ace", "S+":"Serve: tough", "S-":"Serve: neutral", SE:"Serve: error",
               AK:"Attack: kill", AB:"Attack: blocked", "A-":"Attack: defended", AE:"Attack: error",
               BK:"Block: kill", BT:"Block: touch", BM:"Block: miss", BE:"Block: error",
               D3:"Dig: perfect", D2:"Dig: controlled", D1:"Dig: scramble", D0:"Dig: missed",
               T3:"Set: perfect", T2:"Set: good", T1:"Set: off-target", T0:"Set: fault",
               FY:"Free ball: clean", FE:"Free ball: error" };

  // Persistent state structure
  const LS='wpvb_events_roster_rot_v1';
  const load=()=>{ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}} };
  const save=s=>localStorage.setItem(LS,JSON.stringify(s));
  const defaultEvent='Default';
  const S=Object.assign({
    events:{ [defaultEvent]:{ log:[], dash:{}, rot:{ serve:{}, so:{} } } },
    currentEvent: defaultEvent,
    roster:{ Team:[], Opp:[] },
    savedRosters:{ Team:{}, Opp:{} },
    zones:{ Team:{1:null,6:null,5:null,2:null,3:null,4:null}, Opp:{1:null,6:null,5:null,2:null,3:null,4:null} },
    sel:{ side:null, zone:null },
    cur:{ side:'--', player:'', action:'', qual:'' },
    rotationIndex:{ Team:1, Opp:1 },
    rally:{ serveSide:null, soCounted:false },
  }, load());

  const EVT=()=>S.events[S.currentEvent];

  // --- Event management ---
  function renderEvents(){ const sel=$('eventSelect'); sel.innerHTML=''; Object.keys(S.events).forEach(k=>{ const o=el('option','',k); o.value=k; if(k===S.currentEvent) o.selected=true; sel.appendChild(o); }); }
  $('eventAdd').onclick=()=>{ const name=$('eventName').value.trim(); if(!name||S.events[name]) return; S.events[name]={log:[],dash:{},rot:{serve:{},so:{}}}; S.currentEvent=name; $('eventName').value=''; save(S); renderEvents(); renderAllFromEvent(); };
  $('eventDelete').onclick=()=>{ if(S.currentEvent===defaultEvent) return alert('Cannot delete Default event'); if(!confirm('Delete event "'+S.currentEvent+'"?')) return; delete S.events[S.currentEvent]; S.currentEvent=defaultEvent; save(S); renderEvents(); renderAllFromEvent(); };
  $('eventSelect').onchange=e=>{ S.currentEvent=e.target.value; save(S); renderAllFromEvent(); };

  // --- Roster save/load ---
  function renderSavedRosters(){ const tLoad=$('teamRosterLoad'), oLoad=$('oppRosterLoad'); tLoad.innerHTML=''; oLoad.innerHTML=''; Object.keys(S.savedRosters.Team).forEach(k=>{ const o=el('option','',k); o.value=k; tLoad.appendChild(o); }); Object.keys(S.savedRosters.Opp).forEach(k=>{ const o=el('option','',k); o.value=k; oLoad.appendChild(o); }); }
  $('teamRosterSave').onclick=()=>{ const name=$('teamRosterName').value.trim(); if(!name) return; S.savedRosters.Team[name]=[...S.roster.Team]; save(S); renderSavedRosters(); };
  $('teamRosterApply').onclick=()=>{ const key=$('teamRosterLoad').value; if(!key) return; S.roster.Team=[...S.savedRosters.Team[key]]; save(S); renderRoster('Team'); };
  $('oppRosterSave').onclick=()=>{ const name=$('oppRosterName').value.trim(); if(!name) return; S.savedRosters.Opp[name]=[...S.roster.Opp]; save(S); renderSavedRosters(); };
  $('oppRosterApply').onclick=()=>{ const key=$('oppRosterLoad').value; if(!key) return; S.roster.Opp=[...S.savedRosters.Opp[key]]; save(S); renderRoster('Opp'); };

  // --- Roster UI ---
  function addPlayer(side,num,name){ num=num2(num); if(!num||!name) return; if(S.roster[side].some(p=>p.num===num)) return; S.roster[side].push({num,name}); S.roster[side].sort((a,b)=>a.num.localeCompare(b.num)); save(S); renderRoster(side); }
  function removePlayer(side,num){ S.roster[side]=S.roster[side].filter(p=>p.num!==num); Object.keys(S.zones[side]).forEach(z=>{ if(S.zones[side][z]?.num===num) S.zones[side][z]=null; }); save(S); renderRoster(side); renderZones(); }
  function clearRoster(side){ S.roster[side]=[]; Object.keys(S.zones[side]).forEach(z=>S.zones[side][z]=null); save(S); renderRoster(side); renderZones(); }
  function renderRoster(side){ const box=$(side==='Team'?'teamRoster':'oppRoster'); box.innerHTML=''; S.roster[side].forEach(p=>{ const row=el('div','person'); const left=el('div'); left.appendChild(el('span','tag','#'+p.num)); left.appendChild(el('span','name',p.name)); const right=el('div','row'); const setBtn=el('button','btn accent','Assign to Selected'); setBtn.onclick=()=>assignSelected(side,p); const delBtn=el('button','btn ghost','Remove'); delBtn.onclick=()=>removePlayer(side,p.num); right.appendChild(setBtn); right.appendChild(delBtn); row.appendChild(left); row.appendChild(right); box.appendChild(row); }); }

  // --- Court maps ---
  function bindCourt(side){ [1,6,5,2,3,4].forEach(z=>{ const id=(side==='Team'?'team':'opp')+z; const elz=$(id); let t=null; elz.addEventListener('pointerdown',()=>{ t=setTimeout(()=>longClear(side,z),650);}); ['pointerup','pointerleave','pointercancel'].forEach(ev=>elz.addEventListener(ev,()=>{ if(t){clearTimeout(t); t=null;} })); elz.addEventListener('click',()=>selectZone(side,z)); }); }
  function selectZone(side,zone){ S.sel={side,zone}; if(S.zones[side][zone]){ S.cur.side=side; S.cur.player=S.zones[side][zone].num; } renderHints(); renderZones(); updateDisplay(); save(S); }
  function longClear(side,zone){ if(!S.zones[side][zone]) return; if(confirm(`Clear ${side} Z${zone}?`)){ S.zones[side][zone]=null; if(S.cur.side===side && S.cur.player && S.sel.zone===zone){ S.cur.player=''; } save(S); renderZones(); updateDisplay(); } }
  function assignSelected(side,player){ if(!(S.sel.side===side && S.sel.zone)) return; // enforce uniqueness: remove player from any zone first
    Object.keys(S.zones[side]).forEach(z=>{ if(S.zones[side][z]?.num===player.num) S.zones[side][z]=null; });
    S.zones[side][S.sel.zone]={num:player.num,name:player.name}; S.cur.side=side; S.cur.player=player.num; save(S); renderZones(); renderHints(); updateDisplay(); }
  function renderHints(){ $('teamHint').textContent = (S.sel.side==='Team' && S.sel.zone) ? (`Selected: Team Z${S.sel.zone}`) : 'Selected: none'; $('oppHint').textContent = (S.sel.side==='Opp' && S.sel.zone) ? (`Selected: Opp Z${S.sel.zone}`) : 'Selected: none'; }
  function renderZones(){ ['Team','Opp'].forEach(side=>{ Object.keys(S.zones[side]).forEach(z=>{ const p=S.zones[side][z]; const slot=$((side==='Team'?'team':'opp')+z); slot.classList.toggle('active', S.sel.side===side && String(S.sel.zone)===String(z)); const numEl=slot.querySelector('.num'); const nmEl=slot.querySelector('.pname'); numEl.textContent=p?('#'+p.num):''; nmEl.textContent=p?trunc(p.name):''; }); }); }

  // --- Rotation helpers & indices (clockwise when facing net) ---
  const ROT=[1,6,5,4,3,2];
  function rotate(side,dir){ const cur=S.zones[side]; const arr=ROT.map(z=>cur[z]); if(dir==='cw') arr.unshift(arr.pop()); else arr.push(arr.shift()); ROT.forEach((z,i)=>cur[z]=arr[i]); // bump rotation index
    S.rotationIndex[side] = ((S.rotationIndex[side] + (dir==='cw'?1:-1) -1 + 6) % 6) + 1; save(S); renderZones(); }
  $('teamRotateCW').onclick=()=>rotate('Team','cw');
  $('teamRotateCCW').onclick=()=>rotate('Team','ccw');
  $('oppRotateCW').onclick=()=>rotate('Opp','cw');
  $('oppRotateCCW').onclick=()=>rotate('Opp','ccw');

  // --- Actions / Qualifiers / Display ---
  const codeEl=$('code'), pillSide=$('pillSide'), pillP=$('pillPlayer'), pillA=$('pillAction'), pillQ=$('pillQual');
  function updateDisplay(){ const code=(S.cur.player && S.cur.action && S.cur.qual) ? (S.cur.player+S.cur.action+S.cur.qual) : (S.cur.player||'--'); codeEl.textContent=code||'--'; pillSide.textContent='Side: '+(S.cur.side||'--'); pillP.textContent='Player: '+(S.cur.player||'--'); pillA.textContent='Action: '+(S.cur.action||'--'); pillQ.textContent='Qualifier: '+(S.cur.qual||'--'); }
  $('actions').addEventListener('click',e=>{ const a=e.target.getAttribute('data-action'); if(!a) return; S.cur.action=a; S.cur.qual=''; renderQuals(); updateDisplay(); });
  function renderQuals(){ const box=$('quals'); box.innerHTML=''; (QUALS[S.cur.action]||[]).forEach(q=>{ const b=el('button','btn',q); b.addEventListener('click',()=>{ S.cur.qual=q; updateDisplay(); }); box.appendChild(b); }); }

  // --- Rally & rotation metrics ---
  function ensureRotBuckets(){ const srv=EVT().rot.serve, so=EVT().rot.so; for(let i=1;i<=6;i++){ srv[i]=srv[i]||{serves:0,aces:0,errors:0}; so[i]=so[i]||{att:0,succ:0}; } }
  function onServe(side,qual){ ensureRotBuckets(); if(side==='Team'){ const idx=S.rotationIndex.Team; const r=EVT().rot.serve[idx]; r.serves++; if(qual==='A') r.aces++; if(qual==='E') r.errors++; } // start rally
    S.rally.serveSide=side; S.rally.soCounted=false; }
  function onAttackKill(side){ if(!S.rally.serveSide) return; ensureRotBuckets(); const receiving = (S.rally.serveSide==='Team'?'Opp':'Team'); if(side===receiving && !S.rally.soCounted){ if(receiving==='Team'){ const idx=S.rotationIndex.Team; EVT().rot.so[idx].att++; EVT().rot.so[idx].succ++; } S.rally.soCounted=true; } }
  function onNextServeStarted(){ if(!S.rally.serveSide) return; ensureRotBuckets(); const receiving = (S.rally.serveSide==='Team'?'Opp':'Team'); if(!S.rally.soCounted && receiving==='Team'){ const idx=S.rotationIndex.Team; EVT().rot.so[idx].att++; } S.rally.serveSide=null; S.rally.soCounted=false; }

  function renderRotDash(){ ensureRotBuckets(); const tbS=$('rotServe').querySelector('tbody'); tbS.innerHTML=''; for(let i=1;i<=6;i++){ const r=EVT().rot.serve[i]; const acep=r.serves?Math.round(100*r.aces/r.serves):0; const errp=r.serves?Math.round(100*r.errors/r.serves):0; const tr=el('tr'); tr.innerHTML=`<td>SR${i}</td><td>${r.serves}</td><td>${r.aces}</td><td>${r.errors}</td><td>${acep}%</td><td>${errp}%</td>`; tbS.appendChild(tr); }
    const tbR=$('rotSO').querySelector('tbody'); tbR.innerHTML=''; for(let i=1;i<=6;i++){ const r=EVT().rot.so[i]; const p=r.att?Math.round(100*r.succ/r.att):0; const tr=el('tr'); tr.innerHTML=`<td>SO${i}</td><td>${r.att}</td><td>${r.succ}</td><td>${p}%</td>`; tbR.appendChild(tr); } }

  // --- Logging + Player Dashboard ---
  function dashKey(side,num){ return side+":"+num; }
  function bumpDash(side,num,name,action,qual){ const d=EVT().dash; const k=dashKey(side,num); if(!d[k]) d[k]={side,num,name}; const obj=d[k]; const key=action+qual; obj[key]=(obj[key]||0)+1; }
  function renderDash(){ const tb=$('dash').querySelector('tbody'); tb.innerHTML=''; Object.values(EVT().dash).forEach(d=>{ const tr=el('tr'); tr.innerHTML=`<td>${d.side}</td><td>${d.num}</td><td>${d.name||''}</td>
      <td>${d.R3||0}</td><td>${d.R2||0}</td><td>${d.R1||0}</td><td>${d.R0||0}</td>
      <td>${d.SA||0}</td><td>${d['S+']||0}</td><td>${d['S-']||0}</td><td>${d.SE||0}</td>
      <td>${d.AK||0}</td><td>${d.AE||0}</td><td>${d.BK||0}</td><td>${d.BE||0}</td>`; tb.appendChild(tr); }); }

  function appendRow(idx,r){ const tr=el('tr'); tr.innerHTML=`<td>${idx}</td><td>${r.time}</td><td>${r.side}</td><td><b>${r.code}</b></td><td>${r.num}</td><td>${r.name||''}</td><td>${r.action}</td><td>${r.qual}</td><td>${MEAN[r.action+r.qual]||''}</td><td class="table-actions"></td>`; const tools=tr.querySelector('.table-actions'); const del=el('button','btn small','Delete'); del.onclick=()=>{ if(!confirm('Delete this entry?')) return; const i=EVT().log.indexOf(r); if(i>-1){ EVT().log.splice(i,1); save(S); renderLog(); } }; tools.appendChild(del); $('log').querySelector('tbody').appendChild(tr); }
  function renderLog(){ const tb=$('log').querySelector('tbody'); tb.innerHTML=''; EVT().log.forEach((r,i)=>appendRow(i+1,r)); }

  $('enter').addEventListener('click',()=>{
    if(S.cur.side==='--' || !S.cur.player || !S.cur.action || !S.cur.qual){ codeEl.textContent='Tap a court slot → assign player → pick action → qualifier'; return; }
    const side=S.cur.side; const num=S.cur.player; let byZone=null; Object.keys(S.zones[side]).forEach(z=>{ if(S.zones[side][z] && S.zones[side][z].num===num) byZone=S.zones[side][z]; });
    const byRoster=S.roster[side].find(p=>p.num===num); const name=(byZone&&byZone.name) || (byRoster&&byRoster.name) || '';
    const row={time:now(), side, num, name, action:S.cur.action, qual:S.cur.qual}; row.code=num+row.action+row.qual;
    // rally hooks
    if(row.action==='S'){ onServe(side,row.qual); }
    else if(row.action==='A' && row.qual==='K'){ onAttackKill(side); }
    // entering a serve by either side implies new rally start; when a new serve comes in, finalize previous rally attempt
    EVT().log.push(row); bumpDash(side,num,name,row.action,row.qual); save(S);
    renderLog(); renderDash(); renderRotDash();
    S.cur.player=''; S.cur.qual=''; updateDisplay();
  });
  $('reset').addEventListener('click',()=>{ S.cur={side:'--',player:'',action:'',qual:''}; updateDisplay(); });

  // Export / Clear
  $('exportCSV').onclick=()=>{
    const rows=[["event","time","side","num","name","action","qual","code"],...EVT().log.map(r=>[S.currentEvent,r.time,r.side,r.num,r.name,r.action,r.qual,(r.num+r.action+r.qual)])];
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='wolfpack_logger_'+S.currentEvent.replace(/\s+/g,'_')+'.csv'; a.click(); URL.revokeObjectURL(url);
  };
  $('clearLog').onclick=()=>{ if(!confirm('Clear ALL logs for this event?')) return; EVT().log=[]; EVT().dash={}; EVT().rot={serve:{},so:{}}; save(S); renderLog(); renderDash(); renderRotDash(); };

  // Wire roster buttons
  $('teamAdd').onclick=()=>{ if($('teamNum').value && $('teamName').value){ addPlayer('Team', $('teamNum').value, $('teamName').value); $('teamNum').value=''; $('teamName').value=''; }};
  $('teamClear').onclick=()=>{ if(confirm('Clear Team roster & clear court?')) clearRoster('Team'); };
  $('oppAdd').onclick=()=>{ if($('oppNum').value && $('oppName').value){ addPlayer('Opp', $('oppNum').value, $('oppName').value); $('oppNum').value=''; $('oppName').value=''; }};
  $('oppClear').onclick=()=>{ if(confirm('Clear Opponent roster & clear court?')) clearRoster('Opp'); };

  // Boot
  ;['Team','Opp'].forEach(side=>{ bindCourt(side); renderRoster(side); });
  renderEvents(); $('eventSelect').value=S.currentEvent; renderLog(); renderDash(); renderRotDash();
  renderZones(); renderHints(); renderQuals(); updateDisplay(); renderSavedRosters();
})();
</script>
</body>
</html>
