<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">
<link rel="manifest" href="site.webmanifest">
<link rel="icon" type="image/png" sizes="192x192" href="logo-192.png">
<link rel="apple-touch-icon" href="logo-192.png">
<title>WOLFPACK VOLLEYBALL</title>
<style>
  :root{--bg:#ffffff;--card:#f9f9f9;--text:#000;--muted:#6b7280;--line:#e5e7eb;--accent:#ff7f11;}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:40;background:#000;color:#fff;padding:14px 16px;font-weight:900;font-size:18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .nav{display:flex;gap:8px}
  .nav a{color:#fff;text-decoration:none;font-weight:800;border:1px solid rgba(255,255,255,.35);padding:6px 10px;border-radius:999px}
  .nav a.active{background:#fff;color:#000;border-color:transparent}
  .container{max-width:1320px;margin:20px auto;padding:0 16px}
  .grid{display:grid;gap:16px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
  h1{margin:0 0 8px;font-size:18px;color:#000}
  .sub{color:var(--muted);font-size:13px;margin:6px 0 10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{user-select:none;border:1px solid var(--line);border-radius:10px;padding:8px 12px;font-weight:700;font-size:14px;cursor:pointer;background:#fff;color:#000}
  .btn.accent{border-color:transparent;background:linear-gradient(180deg,var(--accent),#f36f00);color:#fff}
  .btn.ghost{background:#fff}
  .btn.small{padding:6px 10px;font-size:12px}
  .input{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;color:#000}
  .input.num{width:90px}
  select.input{padding-right:28px}
  .roster{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff}
  .person{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .tag{background:#fff;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;color:#000;margin-right:8px}
  .name{flex:1 1 auto;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .court{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .slot{border:2px solid var(--line);border-radius:12px;min-height:72px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff;text-align:center;padding:8px;position:relative}
  .slot .zone{position:absolute;top:6px;left:8px;font-size:11px;color:#ff7f11}
  .slot .num{font-weight:900;color:#000}
  .slot .pname{font-size:12px;color:#444}
  .slot.active{outline:3px solid var(--accent)}
  .slot.libero{background:#ffe8d1;border-color:#ff7f11}
  .lib-badge{position:absolute;bottom:6px;right:8px;font-size:10px;background:#ff7f11;color:#fff;border-radius:6px;padding:2px 6px;display:none}
  .slot.libero .lib-badge{display:block}
  .net{grid-column:1/-1;text-align:center;color:#000;font-weight:900;letter-spacing:.1em;border:2px dashed var(--accent);border-radius:10px;padding:4px 0;background:linear-gradient(180deg,#fff,var(--card))}
  .display{display:flex;align-items:center;justify-content:space-between;background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px;margin:8px 0}
  .code{font-size:22px;font-weight:900;color:#ff7f11}
  .pill{background:#fff;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:#000}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
  thead tr{background:#ffe8d1}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:13px}
  th{font-weight:800;color:#000}
  .table-actions button{margin-right:6px}
  .page{display:none}
  .page.active{display:block}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin:8px 0}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;min-height:104px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .kpi .label{font-size:12px;color:var(--muted);letter-spacing:.04em;margin-bottom:8px}
  .kpi .value{font-weight:900;font-size:30px;line-height:1;color:#000}
</style>
</head>
<body>
<header>
  <span style="display:flex;align-items:center;gap:12px">
    <!-- Inline tiny placeholder to avoid 404 on github pages if logo missing -->
    <img src="data:image/gif;base64,R0lGODlhAQABAAAAACw=" style="height:40px" alt="TRU WolfPack Logo">
    <span>WOLFPACK VOLLEYBALL</span>
  </span>
  <nav class="nav">
    <a href="#logger" id="tabLogger" class="active">Logger</a>
    <a href="#dash" id="tabDash">Dashboard</a>
  </nav>
</header>

<!-- LOGGER PAGE -->
<div id="pageLogger" class="page active">
  <div class="container">
    <section class="grid">
      <div class="card">
        <h1>Event / Session</h1>
        <div class="row">
          <select id="eventSelect" class="input" style="min-width:220px"></select>
          <input id="eventName" class="input" placeholder="New event name (e.g., Match vs Bears)">
          <button class="btn accent" id="eventAdd">Add Event</button>
          <button class="btn" id="eventSave">Save All Matches</button>
          <button class="btn" id="eventSaveChanges">Save Current Match</button>
          <button class="btn ghost" id="eventDelete">Delete Event</button>
          <button class="btn" id="eventNew">New Event (Reset)</button>
        </div>
        <div class="sub">One event per match. Each event keeps its own log and dashboards.</div>
      </div>

      <div class="two-col">
        <div class="card">
          <h1>Team Roster</h1>
          <div class="row">
            <input id="teamNum" class="input num" placeholder="Player #" inputmode="numeric">
            <input id="teamName" class="input" style="min-width:220px" placeholder="Player Name">
            <button class="btn accent" id="teamAdd">Add</button>
            <button class="btn ghost" id="teamClear">Clear Roster</button>
          </div>
          <div class="row">
            <input id="teamRosterName" class="input" placeholder="Save roster as (e.g., WolfPack A)">
            <button class="btn" id="teamRosterSave">Save</button>
            <select id="teamRosterLoad" class="input" style="min-width:200px"></select>
            <button class="btn" id="teamRosterApply">Load</button>
            <button class="btn ghost" id="teamRosterDelete">Delete</button>
          </div>
          <div id="teamRoster" class="roster"></div>
          <div class="row" style="margin-top:6px">
            <input id="teamLibNum" class="input num" placeholder="Lib #">
            <button class="btn" id="teamLibSet">Set Libero</button>
            <label style="font-size:13px;color:#444"><input type="checkbox" id="teamLibAuto"> Auto Libero (Backrow Z1/Z6/Z5)</label>
          </div>
        </div>

        <div class="card">
          <h1>Opponent Roster</h1>
          <div class="row">
            <input id="oppNum" class="input num" placeholder="Player #" inputmode="numeric">
            <input id="oppName" class="input" style="min-width:220px" placeholder="Player Name">
            <button class="btn accent" id="oppAdd">Add</button>
            <button class="btn ghost" id="oppClear">Clear Roster</button>
          </div>
          <div class="row">
            <input id="oppRosterName" class="input" placeholder="Save roster as (e.g., Opp A)">
            <button class="btn" id="oppRosterSave">Save</button>
            <select id="oppRosterLoad" class="input" style="min-width:200px"></select>
            <button class="btn" id="oppRosterApply">Load</button>
            <button class="btn ghost" id="oppRosterDelete">Delete</button>
          </div>
          <div id="oppRoster" class="roster"></div>
          <div class="row" style="margin-top:6px">
            <input id="oppLibNum" class="input num" placeholder="Lib #">
            <button class="btn" id="oppLibSet">Set Libero</button>
            <label style="font-size:13px;color:#444"><input type="checkbox" id="oppLibAuto"> Auto Libero (Backrow Z1/Z6/Z5)</label>
          </div>
        </div>
      </div>

      <div class="two-col">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <h1>Team Court</h1>
              <div class="sub">Tap a slot to select. Then tap a roster player to assign. Long-press a slot to clear.</div>
            </div>
            <div class="row">
              <button id="teamRotateCW" class="btn small">Rotate ⟳</button>
              <button id="teamRotateCCW" class="btn small">Rotate ⟲</button>
              <button id="teamClearCourt" class="btn small ghost">Clear Court</button>
            </div>
          </div>
          <div id="teamCourt" class="court">
            <div class="slot" id="team1"><span class="zone">Z1</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="team6"><span class="zone">Z6</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="team5"><span class="zone">Z5</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="team2"><span class="zone">Z2</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="team3"><span class="zone">Z3</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="team4"><span class="zone">Z4</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="net">NET</div>
          </div>
          <div class="sub" id="teamHint">Selected: none</div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <h1>Opponent Court</h1>
              <div class="sub">Tap a slot to select. Then tap a roster player to assign. Long-press a slot to clear.</div>
            </div>
            <div class="row">
              <button id="oppRotateCW" class="btn small">Rotate ⟳</button>
              <button id="oppRotateCCW" class="btn small">Rotate ⟲</button>
              <button id="oppClearCourt" class="btn small ghost">Clear Court</button>
            </div>
          </div>
          <div id="oppCourt" class="court">
            <div class="slot" id="opp1"><span class="zone">Z1</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="opp6"><span class="zone">Z6</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="opp5"><span class="zone">Z5</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="opp2"><span class="zone">Z2</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="opp3"><span class="zone">Z3</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="slot" id="opp4"><span class="zone">Z4</span><div class="num"></div><div class="pname"></div><div class="lib-badge">LIB</div></div>
            <div class="net">NET</div>
          </div>
          <div class="sub" id="oppHint">Selected: none</div>
        </div>
      </div>

      <div class="card">
        <h1>Touch Logger</h1>
        <div class="display">
          <div>
            <div style="font-size:12px;color:var(--muted)">Current Entry</div>
            <div class="code" id="code">--</div>
          </div>
          <div class="row">
            <span class="pill" id="pillSide">Side: --</span>
            <span class="pill" id="pillPlayer">Player: --</span>
            <span class="pill" id="pillAction">Action: --</span>
            <span class="pill" id="pillQual">Qualifier: --</span>
          </div>
        </div>
        <div class="sub">Actions</div>
        <div class="row" id="actions">
          <button class="btn" data-action="R">R (Receive)</button>
          <button class="btn" data-action="S">S (Serve)</button>
          <button class="btn" data-action="T">T (Set)</button>
          <button class="btn" data-action="D">D (Dig)</button>
          <button class="btn" data-action="F">F (Free)</button>
          <button class="btn" data-action="B">B (Block)</button>
          <button class="btn" data-action="A">A (Attack)</button>
        </div>
        <div class="sub">Qualifiers</div>
        <div class="row" id="quals"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn ghost" id="reset">Reset</button>
          <button class="btn accent" id="enter">Enter</button>
        </div>
      </div>

      <div class="card">
        <h1>Event Log</h1>
        <table id="log"><thead><tr><th>#</th><th>Time</th><th>Side</th><th>Code</th><th>P#</th><th>Name</th><th>Action</th><th>Qualifier</th><th>Meaning</th><th>Tools</th></tr></thead><tbody></tbody></table>
        <div class="row" style="margin-top:10px">
          <button id="exportCSV" class="btn">Export CSV</button>
          <button id="clearLog" class="btn ghost">Clear All Logs</button>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- DASHBOARD PAGE -->
<div id="pageDash" class="page">
  <div class="container">
    <div class="card">
      <h1>Team Dashboard</h1>
      <div class="sub">Team KPIs and per-player stats for the selected event.</div>
      <div id="kpiRowTeam" class="kpi-grid"></div>
      <table id="dashTeam"><thead><tr>
        <th>#</th><th>Name</th>
        <th>Eff</th><th>K</th><th>E</th><th>Att</th>
        <th>Good Rec%</th><th>RecTotal</th>
        <th>Good Dig%</th><th>DigTotal</th>
        <th>SE</th><th>SA</th><th>ServPress</th>
        <th>BlockRate</th>
        <th>SO%</th><th>BE</th><th>+/-</th>
      </tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h1>Opponent Dashboard</h1>
      <div class="sub">Opponent KPIs and per-player stats for the selected event.</div>
      <div id="kpiRowOpp" class="kpi-grid"></div>
      <table id="dashOpp"><thead><tr>
        <th>#</th><th>Name</th>
        <th>Eff</th><th>K</th><th>E</th><th>Att</th>
        <th>Good Rec%</th><th>RecTotal</th>
        <th>Good Dig%</th><th>DigTotal</th>
        <th>SE</th><th>SA</th><th>ServPress</th>
        <th>BlockRate</th>
        <th>SO%</th><th>BE</th><th>+/-</th>
      </tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <div><b>+/−</b> = (AK + SA + BK) − (AE + AB + SE + BE)</div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
(function(){
  'use strict';
  const $=id=>document.getElementById(id);
  const el=(t,cls,txt)=>{const e=document.createElement(t); if(cls) e.className=cls; if(txt!==undefined) e.textContent=txt; return e;};
  const num2=v=>String(v||'').replace(/\D/g,'').slice(-2).padStart(2,'0');
  const trunc=(s,n=18)=> (s||'').length>n ? s.slice(0,n-1)+'…' : (s||'');
  const now=()=>new Date().toLocaleTimeString();

  // Qualifiers & meanings
  const QUALS={ R:["3","2","1","0"], S:["A","+","-","E"], A:["K","B","-","E"], B:["K","T","M","E"], D:["3","2","1","0"], T:["3","2","1","0"], F:["Y","E"] };
  const MEAN={ R3:"Receive: excellent", R2:"Receive: good", R1:"Receive: poor", R0:"Receive: loss",
               SA:"Serve: ace", "S+":"Serve: tough", "S-":"Serve: neutral", SE:"Serve: error",
               AK:"Attack: kill", AB:"Attack: blocked", "A-":"Attack: defended", AE:"Attack: error",
               BK:"Block: kill", BT:"Block: touch", BM:"Block: miss", BE:"Block: error",
               D3:"Dig: perfect", D2:"Dig: controlled", D1:"Dig: scramble", D0:"Dig: missed",
               T3:"Set: perfect", T2:"Set: good", T1:"Set: off-target", T0:"Set: fault",
               FY:"Free ball: clean", FE:"Free ball: error" };

  // Persistent state
  const LS='wpvb_events_roster_rot_v3';
  const load=()=>{ try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch(e){return{}} };
  const save=s=>localStorage.setItem(LS,JSON.stringify(s));
  const defaultEvent='Default';

  const S=Object.assign({
    events:{},
    currentEvent: defaultEvent,
    roster:{ Team:[], Opp:[] },
    savedRosters:{ Team:{}, Opp:{} },
    zones:{ Team:{1:null,6:null,5:null,2:null,3:null,4:null}, Opp:{1:null,6:null,5:null,2:null,3:null,4:null} },
    sel:{ side:null, zone:null },
    cur:{ side:'--', player:'', action:'', qual:'' },
    rotationIndex:{ Team:1, Opp:1 },
    libero:{ Team:{ num:'', partners:[], enabled:false }, Opp:{ num:'', partners:[], enabled:false } },
  }, load());
  if(!S.events[defaultEvent]) S.events[defaultEvent]={ log:[], dash:{}, rot:{ serve:{}, so:{} } };
  if(!S.currentEvent) S.currentEvent=defaultEvent;
  const EVT=()=>S.events[S.currentEvent];

  // Tabs
  function applyHash(){ const h=location.hash||'#logger'; const isDash=h==='#dash'; $('tabLogger').classList.toggle('active',!isDash); $('tabDash').classList.toggle('active',isDash); $('pageLogger').classList.toggle('active',!isDash); $('pageDash').classList.toggle('active',isDash); if(isDash) renderDash(); }
  window.addEventListener('hashchange',applyHash);

  // Event mgmt
  function renderEvents(){ const sel=$('eventSelect'); sel.innerHTML=''; Object.keys(S.events).forEach(k=>{ const o=el('option','',k); o.value=k; if(k===S.currentEvent) o.selected=true; sel.appendChild(o); }); }
  $('eventAdd').onclick=()=>{ const name=$('eventName').value.trim(); if(!name) return; if(!S.events[name]) S.events[name]={log:[],dash:{},rot:{serve:{},so:{}}}; S.currentEvent=name; $('eventName').value=''; save(S); renderEvents(); renderAllFromEvent(); };
  $('eventSave').onclick=()=>{ save(S); alert('All matches saved. Current: '+S.currentEvent); };
  $('eventDelete').onclick=()=>{ if(S.currentEvent===defaultEvent) return alert('Cannot delete Default event'); if(!confirm('Delete event "'+S.currentEvent+'"?')) return; delete S.events[S.currentEvent]; S.currentEvent=defaultEvent; save(S); renderEvents(); renderAllFromEvent(); };
  $('eventSelect').onchange=e=>{ S.currentEvent=e.target.value; save(S); renderAllFromEvent(); };
  $('eventSaveChanges').onclick=()=>{ S.events[S.currentEvent] = EVT(); save(S); alert('Current match saved: '+S.currentEvent); };
  $('eventNew').onclick = () => {
    if (!confirm('This will clear ALL events and reset to a fresh Default event. Continue?')) return;
    const fresh = {
      events: { Default: { log: [], dash: {}, rot: { serve: {}, so: {} } } },
      currentEvent: 'Default',
      roster: { Team: [], Opp: [] },
      savedRosters: { Team: {}, Opp: {} },
      zones: { Team: {1:null,6:null,5:null,2:null,3:null,4:null}, Opp: {1:null,6:null,5:null,2:null,3:null,4:null} },
      sel: { side: null, zone: null },
      cur: { side: '--', player: '', action: '', qual: '' },
      rotationIndex: { Team: 1, Opp: 1 },
      libero: { Team: { num: '', partners: [], enabled: false }, Opp: { num: '', partners: [], enabled: false } }
    };
    Object.keys(S).forEach(k => delete S[k]);
    Object.assign(S, fresh);
    save(S);
    renderEvents(); renderAllFromEvent();
    alert('New Default event started.');
  };

  // Saved rosters
  function renderSavedRosters(){ const tLoad=$('teamRosterLoad'), oLoad=$('oppRosterLoad'); tLoad.innerHTML=''; oLoad.innerHTML=''; Object.keys(S.savedRosters.Team).forEach(k=>{ const o=el('option','',k); o.value=k; tLoad.appendChild(o); }); Object.keys(S.savedRosters.Opp).forEach(k=>{ const o=el('option','',k); o.value=k; oLoad.appendChild(o); }); }
  $('teamRosterSave').onclick=()=>{ const name=$('teamRosterName').value.trim(); if(!name) return; S.savedRosters.Team[name]=[...S.roster.Team]; save(S); renderSavedRosters(); };
  $('teamRosterApply').onclick=()=>{ const key=$('teamRosterLoad').value; if(!key) return; S.roster.Team=[...S.savedRosters.Team[key]]; save(S); renderRoster('Team'); };
  $('teamRosterDelete').onclick=()=>{ const key=$('teamRosterLoad').value; if(!key) return; delete S.savedRosters.Team[key]; save(S); renderSavedRosters(); };
  $('oppRosterSave').onclick=()=>{ const name=$('oppRosterName').value.trim(); if(!name) return; S.savedRosters.Opp[name]=[...S.roster.Opp]; save(S); renderSavedRosters(); };
  $('oppRosterApply').onclick=()=>{ const key=$('oppRosterLoad').value; if(!key) return; S.roster.Opp=[...S.savedRosters.Opp[key]]; save(S); renderRoster('Opp'); };
  $('oppRosterDelete').onclick=()=>{ const key=$('oppRosterLoad').value; if(!key) return; delete S.savedRosters.Opp[key]; save(S); renderSavedRosters(); };

  // Roster & court
  function addPlayer(side,num,name){ num=num2(num); if(!num||!name) return; if(S.roster[side].some(p=>p.num===num)) return; S.roster[side].push({num,name}); S.roster[side].sort((a,b)=>a.num.localeCompare(b.num)); save(S); renderRoster(side); }
  function removePlayer(side,num){ S.roster[side]=S.roster[side].filter(p=>p.num!==num); Object.keys(S.zones[side]).forEach(z=>{ if(S.zones[side][z]?.num===num) S.zones[side][z]=null; }); save(S); renderRoster(side); renderZones(); }
  function clearRoster(side){
    S.roster[side]=[];
    Object.keys(S.zones[side]).forEach(z=>S.zones[side][z]=null);
    S.libero[side]={ num:'', partners:[], enabled:false };
    if(S.sel.side===side){ S.sel={side:null,zone:null}; }
    if(S.cur.side===side){ S.cur={ side:'--', player:'', action:'', qual:''}; }
    save(S);
    renderRoster(side); renderZones(); renderHints(); updateDisplay();
  }
  function renderRoster(side){ const box=(side==='Team'?$('teamRoster'):$('oppRoster')); box.innerHTML=''; const L=S.libero[side];
    (S.roster[side]).forEach(p=>{
      const row=el('div','person');
      const left=el('div'); left.appendChild(el('span','tag','#'+p.num)); left.appendChild(el('span','name',p.name+(L.num===p.num?' (L)':'')));
      const right=el('div','row');
      const setBtn=el('button','btn accent','Assign'); setBtn.onclick=()=>assignSelected(side,p);
      const delBtn=el('button','btn ghost','Remove'); delBtn.onclick=()=>removePlayer(side,p.num);
      const partnerBtn=el('button','btn small', L.partners.includes(p.num)?'Partner ✓':'Partner');
      partnerBtn.onclick=()=>{ const i=L.partners.indexOf(p.num); if(i>-1) L.partners.splice(i,1); else if(p.num!==L.num && L.partners.length<2) L.partners.push(p.num); save(S); renderRoster(side); renderZones(); };
      right.appendChild(setBtn); right.appendChild(delBtn); right.appendChild(partnerBtn); row.appendChild(left); row.appendChild(right); box.appendChild(row);
    });
  }

  // Libero
  $('teamLibSet').onclick=()=>{ S.libero.Team.num=num2($('teamLibNum').value); if(S.libero.Team.partners.includes(S.libero.Team.num)) S.libero.Team.partners=S.libero.Team.partners.filter(x=>x!==S.libero.Team.num); save(S); renderRoster('Team'); renderZones(); };
  $('oppLibSet').onclick=()=>{ S.libero.Opp.num=num2($('oppLibNum').value); if(S.libero.Opp.partners.includes(S.libero.Opp.num)) S.libero.Opp.partners=S.libero.Opp.partners.filter(x=>x!==S.libero.Opp.num); save(S); renderRoster('Opp'); renderZones(); };
  $('teamLibAuto').onchange=e=>{ S.libero.Team.enabled=!!e.target.checked; save(S); renderZones(); };
  $('oppLibAuto').onchange=e=>{ S.libero.Opp.enabled=!!e.target.checked; save(S); renderZones(); };

  // Court interactions
  function bindCourt(side){ [1,6,5,2,3,4].forEach(z=>{ const id=(side==='Team'?'team':'opp')+z; const elz=$(id); let t=null; elz.addEventListener('pointerdown',()=>{ t=setTimeout(()=>longClear(side,z),650);}); ['pointerup','pointerleave','pointercancel'].forEach(ev=>elz.addEventListener(ev,()=>{ if(t){clearTimeout(t); t=null;} })); elz.addEventListener('click',()=>selectZone(side,z)); }); }
  function selectZone(side,zone){ S.sel={side,zone}; const disp=getDisplayPlayer(side,zone); if(disp){ S.cur.side=side; S.cur.player=disp.num; } else { S.cur.side=side; S.cur.player=''; } renderHints(); renderZones(); updateDisplay(); save(S); }
  function longClear(side,zone){ if(!S.zones[side][zone]) return; if(confirm(`Clear ${side} Z${zone}?`)){ S.zones[side][zone]=null; if(S.cur.side===side && S.sel.zone===zone){ S.cur.player=''; } save(S); renderZones(); updateDisplay(); } }
  function assignSelected(side,player){ if(!(S.sel.side===side && S.sel.zone)) return;
    Object.keys(S.zones[side]).forEach(z=>{ if(S.zones[side][z]?.num===player.num) S.zones[side][z]=null; });
    S.zones[side][S.sel.zone]={num:player.num,name:player.name}; S.cur.side=side; const disp=getDisplayPlayer(side,S.sel.zone); S.cur.player=disp?disp.num:player.num; save(S); renderZones(); renderHints(); updateDisplay(); }
  function renderHints(){ $('teamHint').textContent = (S.sel.side==='Team' && S.sel.zone) ? (`Selected: Team Z${S.sel.zone}`) : 'Selected: none'; $('oppHint').textContent = (S.sel.side==='Opp' && S.sel.zone) ? (`Selected: Opp Z${S.sel.zone}`) : 'Selected: none'; }

  const BACKROW=new Set([1,6,5]);
  function getDisplayPlayer(side,zone){ const p=S.zones[side][zone]; if(!p) return null; const L=S.libero[side]; if(BACKROW.has(zone) && L.enabled && L.num && L.partners.includes(p.num)){
      const lib= S.roster[side].find(x=>x.num===L.num) || {num:L.num,name:'Libero'}; return {num:lib.num,name:lib.name,isLib:true};
    }
    return {num:p.num,name:p.name,isLib:false}; }

  function renderZones(){ ['Team','Opp'].forEach(side=>{ Object.keys(S.zones[side]).forEach(z=>{ const zi=Number(z); const slot=$((side==='Team'?'team':'opp')+z); const disp=getDisplayPlayer(side,zi); const isActive = (S.sel.side===side && String(S.sel.zone)===String(z)); slot.classList.toggle('active', isActive); slot.classList.toggle('libero', !!(disp&&disp.isLib && BACKROW.has(zi))); const numEl=slot.querySelector('.num'); const nmEl=slot.querySelector('.pname'); if(disp){ numEl.textContent='#'+disp.num; nmEl.textContent=trunc(disp.name + (disp.isLib?' (L)':'')); } else { numEl.textContent=''; nmEl.textContent=''; } }); }); }

  // Rotation
  const ROT=[1,6,5,4,3,2];
  function rotate(side,dir){ const cur=S.zones[side]; const arr=ROT.map(z=>cur[z]); if(dir==='cw') arr.unshift(arr.pop()); else arr.push(arr.shift()); ROT.forEach((z,i)=>cur[z]=arr[i]); S.rotationIndex[side] = ((S.rotationIndex[side] + (dir==='cw'?1:-1) -1 + 6) % 6) + 1; save(S); renderZones(); }
  ;['Team','Opp'].forEach(bindCourt);
  $('teamRotateCW').onclick=()=>rotate('Team','cw');
  $('teamRotateCCW').onclick=()=>rotate('Team','ccw');
  $('oppRotateCW').onclick=()=>rotate('Opp','cw');
  $('oppRotateCCW').onclick=()=>rotate('Opp','ccw');
  $('teamClearCourt').onclick=()=>{ Object.keys(S.zones.Team).forEach(z=>S.zones.Team[z]=null); save(S); renderZones(); };
  $('oppClearCourt').onclick=()=>{ Object.keys(S.zones.Opp).forEach(z=>S.zones.Opp[z]=null); save(S); renderZones(); };

  // Logger
  const codeEl=$('code'), pillSide=$('pillSide'), pillP=$('pillPlayer'), pillA=$('pillAction'), pillQ=$('pillQual');
  function updateDisplay(){ const code=(S.cur.player && S.cur.action && S.cur.qual) ? (S.cur.player+S.cur.action+S.cur.qual) : (S.cur.player||'--'); codeEl.textContent=code||'--'; pillSide.textContent='Side: '+(S.cur.side||'--'); pillP.textContent='Player: '+(S.cur.player||'--'); pillA.textContent='Action: '+(S.cur.action||'--'); pillQ.textContent='Qualifier: '+(S.cur.qual||'--'); }
  $('actions').addEventListener('click',e=>{ const btn=e.target.closest('button[data-action]'); if(!btn) return; const a=btn.getAttribute('data-action'); S.cur.action=a; S.cur.qual=''; renderQuals(); updateDisplay(); });
  function renderQuals(){ const box=$('quals'); box.innerHTML=''; (QUALS[S.cur.action]||[]).forEach(q=>{ const b=el('button','btn',q); b.addEventListener('click',()=>{ S.cur.qual=q; updateDisplay(); }); box.appendChild(b); }); }

  // Dash helpers
  function dashKey(side,num){ return side+":"+num; }
  function bumpDash(side,num,name,action,qual){ const d=EVT().dash; const k=dashKey(side,num); if(!d[k]) d[k]={side,num,name}; const obj=d[k]; const key=action+qual; obj[key]=(obj[key]||0)+1; }

  function computeRallies(log){
    const rallies=[]; let cur=null;
    const startRally=(serveSide)=>{cur={serveSide, entries:[]}; rallies.push(cur);};
    log.forEach(e=>{
      if(e.action==='S') { startRally(e.side); }
      if(!rallies.length) startRally(e.side||'Team');
      rallies[rallies.length-1].entries.push(e);
    });
    const out={Team:{att:0,succ:0}, Opp:{att:0,succ:0}, byPlayer:{}};
    rallies.forEach(r=>{
      const recv = (r.serveSide==='Team'?'Opp':'Team');
      out[recv].att++;
      const killer = r.entries.find(x=>x.side===recv && x.action==='A' && x.qual==='K');
      if(killer){ out[recv].succ++; const k=killer.side+":"+killer.num; const by=out.byPlayer; if(!by[k]) by[k]={att:0,succ:0}; by[k].att++; by[k].succ++; }
    });
    return out;
  }

  function renderDash(){
    const agg={};
    const ensure=(side,num,name)=>{const k=side+":"+num; if(!agg[k]) agg[k]={side,num,name}; return agg[k];};
    EVT().log.forEach(r=>{ const a=ensure(r.side,r.num,r.name); const key=r.action+(r.qual||''); a[key]=(a[key]||0)+1; });
    const so=computeRallies(EVT().log);
    Object.entries(so.byPlayer).forEach(([k,v])=>{ agg[k]=agg[k]||{side:k.split(':')[0],num:k.split(':')[1],name:''}; agg[k].SOatt=(agg[k].SOatt||0)+v.att; agg[k].SOsucc=(agg[k].SOsucc||0)+v.succ; });
    const players=Object.values(agg);
    const bySide={Team:[],Opp:[]}; players.forEach(d=>{ if(d.side==='Team') bySide.Team.push(d); else if(d.side==='Opp') bySide.Opp.push(d); });

    function fillTable(side){
      const tb=(side==='Team'?$('dashTeam'):$('dashOpp')).querySelector('tbody');
      tb.innerHTML='';
      bySide[side].sort((a,b)=>a.num.localeCompare(b.num));
      bySide[side].forEach(d=>{
        const att=(d.AK||0)+(d.AE||0)+(d['A-']||0)+(d.AB||0);
        const eff=att?(((d.AK||0)-(d.AE||0))/att):0; /* updated formula (AK-AE)/(AK+AE+AB+A-) */
        const rTot=(d.R3||0)+(d.R2||0)+(d.R1||0)+(d.R0||0);
        const rRate=rTot?(((d.R3||0)+(d.R2||0))/rTot):0; /* Good Receive % */
        const dTot=(d.D3||0)+(d.D2||0)+(d.D1||0)+(d.D0||0);
        const dRate=dTot?(((d.D3||0)+(d.D2||0))/dTot):0; /* Good Dig % */
        const sTot=(d.SA||0)+(d['S+']||0)+(d['S-']||0)+(d.SE||0);
        const sPress=sTot?(((d.SA||0)+(d['S+']||0))/sTot):0;
        const bTot=(d.BK||0)+(d.BE||0)+(d.BT||0);
        const bRate=bTot?((d.BK||0)/bTot):0;
        const soAtt=d.SOatt||0, soSucc=d.SOsucc||0, soRate=soAtt?soSucc/soAtt:0;
        const be=d.BE||0;
        const plusMinus=(d.AK||0)+(d.SA||0)+(d.BK||0) - ((d.AE||0)+(d.AB||0)+(d.SE||0)+(d.BE||0));
        const tr=el('tr');
        tr.innerHTML=`<td>${d.num}</td><td>${d.name||''}</td>
          <td>${(eff*100).toFixed(0)}%</td><td>${d.AK||0}</td><td>${d.AE||0}</td><td>${att}</td>
          <td>${(rRate*100).toFixed(0)}%</td><td>${rTot}</td>
          <td>${(dRate*100).toFixed(0)}%</td><td>${dTot}</td>
          <td>${d.SE||0}</td><td>${d.SA||0}</td><td>${(sPress*100).toFixed(0)}%</td>
          <td>${(bRate*100).toFixed(0)}%</td>
          <td>${(soRate*100).toFixed(0)}%</td><td>${be}</td><td style="color:${plusMinus<0?'red':'green'}">${plusMinus}</td>`;
        tb.appendChild(tr);
      });
    }

    function renderKPI(side){
      const holder=$(side==='Team'?'kpiRowTeam':'kpiRowOpp');
      holder.innerHTML='';
      const list=(side==='Team'?bySide.Team:bySide.Opp);
      const sum=(fn)=>list.reduce((t,d)=>t+fn(d),0);
      const attTotal=sum(d=> (d.AK||0)+(d.AE||0)+(d.AB||0)+(d['A-']||0));
      const eff=attTotal? ((sum(d=>d.AK||0) - sum(d=>d.AE||0)) / attTotal):0; // UPDATED FORMULA
      const r3=sum(d=>d.R3||0), r2=sum(d=>d.R2||0), r1=sum(d=>d.R1||0), r0=sum(d=>d.R0||0);
      const rTot=r3+r2+r1+r0;
      const rPts=3*r3+2*r2+1*r1;
      const rAvg=rTot? (rPts/rTot):0;
      const rRate=rTot? ((r3+r2)/rTot):0;
      const dTot=sum(d=>(d.D3||0)+(d.D2||0)+(d.D1||0)+(d.D0||0));
      const dRate=dTot? ((sum(d=>(d.D3||0)+(d.D2||0)))/dTot):0;
      const sTot=sum(d=>(d.SA||0)+(d['S+']||0)+(d['S-']||0)+(d.SE||0));
      const sAces=sum(d=>d.SA||0), sErr=sum(d=>d.SE||0);
      const sPress=sTot?((sum(d=>(d.SA||0)+(d['S+']||0)))/sTot):0;
      const bTot=sum(d=>(d.BK||0)+(d.BE||0)+(d.BT||0));
      const bRate=bTot? (sum(d=>d.BK||0)/bTot):0;
      const soAtt=sum(d=>d.SOatt||0), soSucc=sum(d=>d.SOsucc||0); const soRate=soAtt?soSucc/soAtt:0;
      const bubbles=[
        {label:'TEAM ATTACK EFFICIENCY', val:`${(eff*100).toFixed(0)}%`},
        {label:'SERVES', val:String(sTot)},
        {label:'SERVICE ACES', val:String(sAces)},
        {label:'SERVICE ERRORS', val:String(sErr)},
        {label:'SERVICE PRESSURE', val:`${(sPress*100).toFixed(0)}%`},
        {label:'RECEIVE AVERAGE (0–3)', val:rAvg.toFixed(2)},
        {label:'GOOD RECEIVE %', val:`${(rRate*100).toFixed(0)}%`},
        {label:'TOTAL RECEIVES', val:String(rTot)},
        {label:'GOOD DIG %', val:`${(dRate*100).toFixed(0)}%`},
        {label:'TOTAL DIGS', val:String(dTot)},
        {label:'BLOCK RATE', val:`${(bRate*100).toFixed(0)}%`},
        {label:'SIDE OUT %', val:`${(soRate*100).toFixed(0)}%`}
      ];
      bubbles.forEach(b=>{ const k=el('div','kpi'); k.appendChild(el('div','label',b.label)); k.appendChild(el('div','value',b.val)); holder.appendChild(k); });
    }

    fillTable('Team'); fillTable('Opp'); renderKPI('Team'); renderKPI('Opp');
  }

  // Log table + actions
  function appendRow(idx,r){
    const tr=el('tr');
    tr.innerHTML=`<td>${idx}</td><td>${r.time}</td><td>${r.side}</td><td><b>${r.code}</b></td><td>${r.num}</td><td>${r.name||''}</td><td>${r.action}</td><td>${r.qual}</td><td>${MEAN[r.action+r.qual]||''}</td><td class="table-actions"><button class="btn small delRow" data-i="${idx-1}">Delete</button></td>`;
    $('log').querySelector('tbody').appendChild(tr);
  }
  $('log').querySelector('tbody').addEventListener('click', (e)=>{
    const btn=e.target.closest('.delRow');
    if(!btn) return;
    const i=Number(btn.getAttribute('data-i'));
    if(Number.isInteger(i) && i>=0 && i<EVT().log.length){ EVT().log.splice(i,1); save(S); renderLog(); renderDash(); }
  });
  function renderLog(){ const tb=$('log').querySelector('tbody'); tb.innerHTML=''; EVT().log.forEach((r,i)=>appendRow(i+1,r)); }

  // Enter/reset/export/clear
  $('enter').addEventListener('click',()=>{
    if(S.cur.side==='--' || !S.cur.player || !S.cur.action || !S.cur.qual){ $('code').textContent='Tap a court slot → assign player → pick action → qualifier'; return; }
    const side=S.cur.side; const num=S.cur.player; let byZone=null; Object.keys(S.zones[side]).forEach(z=>{ if(S.zones[side][z] && S.zones[side][z].num===num) byZone=S.zones[side][z]; });
    const byRoster=S.roster[side].find(p=>p.num===num); const name=(byZone&&byZone.name) || (byRoster&&byRoster.name) || '';
    const row={time:now(), side, num, name, action:S.cur.action, qual:S.cur.qual}; row.code=num+row.action+row.qual;
    EVT().log.push(row); bumpDash(side,num,name,row.action,row.qual); save(S);
    renderLog(); renderDash();
    S.cur.player=''; S.cur.qual=''; updateDisplay();
  });
  $('reset').addEventListener('click',()=>{ S.cur={side:'--',player:'',action:'',qual:''}; updateDisplay(); });
  $('exportCSV').onclick=()=>{
    const rows=[["event","time","side","num","name","action","qual","code"],...EVT().log.map(r=>[S.currentEvent,r.time,r.side,r.num,r.name,r.action,r.qual,(r.num+r.action+r.qual)])];
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='wolfpack_logger_'+S.currentEvent.replace(/\s+/g,'_')+'.csv'; a.click(); URL.revokeObjectURL(url);
  };
  $('clearLog').onclick=()=>{
    if(!confirm('Clear ALL logs for this event?')) return;
    const ev=EVT(); ev.log=[]; ev.dash={}; ev.rot={ serve:{}, so:{} };
    save(S); renderLog(); renderDash(); renderZones(); updateDisplay();
    $('code').textContent='--';
    alert('All logs cleared for event: '+S.currentEvent);
  };

  // Roster buttons
  $('teamAdd').onclick=()=>{ if($('teamNum').value && $('teamName').value){ addPlayer('Team', $('teamNum').value, $('teamName').value); $('teamNum').value=''; $('teamName').value=''; }};
  $('teamClear').onclick=()=>{ if(confirm('Clear Team roster, libero, and court?')){ clearRoster('Team'); alert('Team roster and court cleared.'); } };
  $('oppAdd').onclick=()=>{ if($('oppNum').value && $('oppName').value){ addPlayer('Opp', $('oppNum').value, $('oppName').value); $('oppNum').value=''; $('oppName').value=''; }};
  $('oppClear').onclick=()=>{ if(confirm('Clear Opponent roster, libero, and court?')){ clearRoster('Opp'); alert('Opponent roster and court cleared.'); } };

  // Boot
  ['Team','Opp'].forEach(side=>{ bindCourt(side); renderRoster(side); });
  function renderAllFromEvent(){ renderLog(); renderDash(); renderZones(); renderHints(); renderQuals(); updateDisplay(); renderRoster('Team'); renderRoster('Opp'); }
  renderEvents(); if($('eventSelect')) $('eventSelect').value=S.currentEvent; renderAllFromEvent();
  applyHash();

  // --- Minimal self-tests (won't affect UI) ---
  try{
    console.assert(typeof EVT==='function','EVT function missing');
    console.assert(document.getElementById('actions'), '#actions missing');
    console.assert(document.getElementById('dashTeam'), '#dashTeam missing');
  }catch(err){ console.warn('Self-test warning:', err); }

})();
});
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js', { scope: './' }).catch(console.error);
  });
}
</script>
</body>
</html>
